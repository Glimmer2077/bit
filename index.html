<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BentoHabit">
    <link rel="apple-touch-icon" id="dynamic-icon" href="">
    <title>Habit Tracker V2.3 Neon</title>
    <style>
        /* --- æ ¸å¿ƒå˜é‡ --- */
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #000000;
            --c-lemon: #EBFF00; --c-taro: #C8B6FF; --c-blue: #4A90E2;
            --c-pink: #FF2D55; --c-orange: #FF9500; --c-green: #34C759;
            --radius-box: 24px;
            --nav-height: 80px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* --- åŸºç¡€é‡ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: auto !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; height: 100dvh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .app-container { flex: 1; position: relative; overflow: hidden; max-width: 450px; margin: 0 auto; width: 100%; background: var(--bg-color); }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: calc(var(--safe-top) + 20px) 20px calc(var(--nav-height) + var(--safe-bottom) + 40px) 20px;
            display: none; scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æ’ç‰ˆä¸å¡ç‰‡ --- */
        h1 { font-size: 3rem; font-weight: 900; margin: 10px 0 30px 0; line-height: 1; letter-spacing: -0.03em; }
        h2 { font-size: 1.5rem; font-weight: 800; margin: 30px 0 15px 0; }
        h3 { font-size: 1.1rem; font-weight: 800; margin: 0; }
        .card-list { display: flex; flex-direction: column; gap: 20px; }
        .card {
            background: var(--card-bg); border-radius: var(--radius-box); padding: 25px;
            position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); transition: transform 0.1s;
        }
        .card.full { width: 100%; }
        
        /* --- é¢œè‰² --- */
        .bg-lemon { background-color: var(--c-lemon); }
        .bg-taro { background-color: var(--c-taro); }
        .bg-blue { background-color: var(--c-blue); color: white; }
        .bg-pink { background-color: var(--c-pink); color: white; }
        .bg-orange { background-color: var(--c-orange); }
        .bg-green { background-color: var(--c-green); color: white; }

        .big-num { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: -0.05em; }
        .label { font-size: 0.8rem; font-weight: 700; opacity: 0.7; text-transform: uppercase; margin-top: auto; }
        
        .list-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .habit-name { font-size: 1.8rem; font-weight: 800; line-height: 1.1; }
        .mini-stats { display: flex; gap: 20px; }
        .mini-stat-val { font-size: 1.5rem; font-weight: 900; }
        .mini-stat-lbl { font-size: 0.7rem; font-weight: 600; opacity: 0.6; }

        /* --- å¾½ç« é¢„è§ˆ --- */
        .badge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .badge-toggle-btn { font-size: 0.8rem; font-weight: 700; color: var(--c-blue); cursor: pointer; }
        .badge-preview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .badge-preview { 
            aspect-ratio: 1; border-radius: 16px; background: #F0F0F0; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            opacity: 0.4; filter: grayscale(1); color: #000;
        }
        .badge-preview.unlocked { opacity: 1; filter: grayscale(0); background: #F5F5F7 !important; }
        .badge-preview svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- V2.3 æ ¸å¿ƒï¼šStack Overlay & Physics --- */
        .stack-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 3000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .stack-overlay.open { transform: translateY(0); }
        
        /* æ ‡é¢˜æ  (ä¿®æ­£å°ºå¯¸) */
        .stack-header { 
            padding: calc(var(--safe-top) + 20px) 20px 10px 20px; 
            background: #000; color: white;
            z-index: 100; flex-shrink: 0;
            display: flex; flex-direction: column; gap: 10px;
        }
        .stack-title-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .stack-title { font-size: 2rem; font-weight: 900; line-height: 1; text-transform: uppercase; letter-spacing: 0.02em; } /* ç¼©å°å­—å·é˜²æ­¢æŒ¤å‹ */
        .stack-count { font-size: 1rem; font-weight: 700; opacity: 0.6; margin-bottom: 2px; font-variant-numeric: tabular-nums; }
        
        /* é¡¶éƒ¨è¿›åº¦æ¡ */
        .stack-progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .stack-progress-bar { height: 100%; width: 0%; background: #fff; transition: width 0.2s; }

        /* æ»šåŠ¨å®¹å™¨ (ç‰©ç†å¼•æ“ Scroll Snap) */
        .stack-scroll-area { 
            flex: 1; overflow-y: auto; 
            padding: 20px 20px 150px 20px; /* åº•éƒ¨åŠ åšPaddingé˜²æ­¢æœ€åä¸€å¼ æ— æ³•ç½®é¡¶ */
            scrollbar-width: none;
            scroll-snap-type: y mandatory; /* æ ¸å¿ƒï¼šå¼ºåˆ¶æ•æ‰ */
        }
        
        /* ç²˜æ€§å¡ç‰‡ */
        .stack-card {
            position: sticky; top: 20px;
            scroll-snap-align: start; /* æ ¸å¿ƒï¼šå¯¹é½ç‚¹ */
            scroll-margin-top: 20px; /* ä¿®æ­£å¯¹é½åç§» */
            min-height: 70vh; 
            background: white; border-radius: 24px; 
            padding: 30px; margin-bottom: 40px; 
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            border-top: 1px solid rgba(255,255,255,0.2);
            color: #000; overflow: hidden;
        }
        
        /* 1. å·²è§£é” (Solid) */
        .stack-card.unlocked { color: #000; border: none; }
        /* 2. æœªè§£é” (Neon Outline) */
        .stack-card.locked { 
            background: #1C1C1E !important; 
            color: #fff;
            border: 3px solid currentColor; /* è§å…‰è¾¹æ¡† */
        }
        .stack-card.locked .stk-icon { background: transparent !important; border: 2px solid currentColor; color: inherit !important; }
        .stack-card.locked .stk-tag { background: #333 !important; color: #999 !important; }

        /* å¡ç‰‡å†…å®¹ */
        .stk-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 2; }
        .stk-icon { width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; font-size: 1.5rem; font-weight: 900; }
        .stk-icon svg { width: 32px; height: 32px; fill: currentColor; }
        .stk-tag { padding: 6px 12px; border-radius: 20px; background: #000; color: #fff; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        
        .stk-body { margin-top: auto; padding-bottom: 20px; position: relative; z-index: 2; }
        .stk-name { font-size: 2.2rem; font-weight: 900; line-height: 1; margin-bottom: 10px; letter-spacing: -0.03em; }
        .stk-desc { font-size: 1rem; font-weight: 600; opacity: 0.7; line-height: 1.4; max-width: 85%; }
        
        /* å·¨å‹æ°´å°ç¼–å· (Watermark) */
        .stk-watermark {
            position: absolute; bottom: -20px; right: -10px;
            font-size: 140px; font-weight: 900; opacity: 0.08; /* ææ·¡ */
            pointer-events: none; z-index: 1; line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        /* å…³é—­æŒ‰é’® */
        .stack-close-fab {
            position: absolute; bottom: calc(var(--safe-bottom) + 30px); right: 30px;
            width: 60px; height: 60px; border-radius: 50%; background: #fff; color: #000;
            display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 300;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; z-index: 200; 
            transition: transform 0.2s;
        }
        .stack-close-fab:active { transform: scale(0.9); }

        /* --- è¯¦æƒ…å¼¹çª— (Modal) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000;
            display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: calc(var(--safe-top) + 20px) 20px 40px 20px;
        }
        .modal.open { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; cursor: pointer; }
        .modal-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scrollbar-width: none; padding-bottom: 40px; }
        
        .view-toggle { display: flex; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 12px; margin-bottom: 10px; flex-shrink: 0; }
        .view-btn { flex: 1; padding: 8px; text-align: center; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #999; }
        .view-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .recent-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; }
        .recent-block { 
            width: 100%; aspect-ratio: 1; border-radius: 8px; background: rgba(0,0,0,0.05); 
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; font-weight: 700; color: rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .recent-block.active { box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: rgba(0,0,0,0.5); }
        .recent-block.today { border: 2px solid rgba(0,0,0,0.1); }

        .year-tabs-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .year-tab { padding: 6px 16px; background: #eee; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #999; flex-shrink: 0; transition: all 0.2s; }
        .year-tab.active { background: black; color: white; }
        .year-grid-container { overflow-x: auto; padding-bottom: 10px; }
        .year-grid { display: grid; grid-template-rows: repeat(7, 10px); grid-auto-flow: column; gap: 3px; width: max-content; }
        .year-dot { width: 10px; height: 10px; background: #eee; border-radius: 2px; }
        .month-separator { width: 1px; height: 100%; background: rgba(0,0,0,0.1); margin: 0 2px; grid-row: 1 / -1; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: #fff; border-radius: var(--radius-box); padding: 15px; display: flex; flex-direction: column; justify-content: space-between; min-height: 100px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .stat-val { font-size: 1.8rem; font-weight: 900; line-height: 1; }
        .stat-lbl { font-size: 0.7rem; font-weight: 700; color: #999; margin-top: 5px; }

        .check-btn-container { margin-top: auto; padding-top: 20px; flex-shrink: 0; }
        .big-check-btn {
            width: 100%; height: 80px; border-radius: 40px; border: none; background: #000; color: #fff; 
            font-size: 1.5rem; font-weight: 800; display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .big-check-btn:active { transform: scale(0.95); }
        .big-check-btn.checked { background: var(--c-green); color: white; }

        /* --- å¯¼èˆªä¸å½’æ¡£ --- */
        details summary { list-style: none; padding: 20px; background: #E5E5EA; border-radius: var(--radius-box); font-weight: 700; color: #666; display: flex; justify-content: space-between; align-items: center; }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .archived-list { background: #E5E5EA; border-bottom-left-radius: var(--radius-box); border-bottom-right-radius: var(--radius-box); padding: 0 20px 20px 20px; }
        
        .tab-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px;
            height: calc(var(--nav-height) + var(--safe-bottom)); background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); z-index: 100;
        }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #999; font-size: 0.7rem; font-weight: 600; }
        .tab-item.active { color: black; }
        .tab-icon { width: 24px; height: 24px; background: currentColor; margin-bottom: 4px; border-radius: 6px; transition: transform 0.2s; }
        .tab-item.active .tab-icon { transform: scale(1.1); }

        /* --- é€šç”¨å¼¹çª— --- */
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .dialog-card { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 30px 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 10px; }
        .dialog-desc { font-size: 0.9rem; color: #666; line-height: 1.5; margin-bottom: 20px; }
        .dialog-input { width: 100%; padding: 15px; background: #F2F2F7; border: none; border-radius: 12px; font-size: 1rem; margin-bottom: 20px; outline: none; }
        .dialog-textarea { width: 100%; height: 80px; padding: 10px; background: #F2F2F7; border: none; border-radius: 12px; font-size: 0.8rem; margin-bottom: 20px; resize: none; outline: none; font-family: monospace; }
        .dialog-btn-group { display: flex; gap: 10px; width: 100%; justify-content: center; }
        .dialog-btn-vertical { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .dialog-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: none; font-size: 1rem; cursor: pointer; display:flex; justify-content: center; align-items: center; gap: 8px;}
        .btn-cancel { background: #F2F2F7; color: black; }
        .btn-confirm { background: var(--c-blue); color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        .btn-action { background: black; color: white; width: 100%; }
        .btn-action-outline { background: white; color: black; border: 2px solid #eee; width: 100%; }
        .small-tip { font-size: 0.7rem; color: #999; margin-top: 10px; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 3000; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<input type="file" id="import-file" accept=".txt,.json" style="display:none" onchange="IO.handleFileSelect(this)">

<div class="app-container">
    <div id="page-tracker" class="page active">
        <h1>ä¹ æƒ¯åˆ—è¡¨</h1>
        <div id="habit-list" class="card-list"></div>
        <div id="empty-state" style="display:none; text-align:center; padding:40px; color:#999;">è¿˜æ²¡æœ‰ä¹ æƒ¯ï¼Œå»"ç®¡ç†"é¡µé¢æ·»åŠ ä¸€ä¸ªå§ï¼</div>
    </div>

    <div id="page-manage" class="page">
        <h1>ä¹ æƒ¯ç®¡ç†</h1>
        <div class="card bg-blue" onclick="UI.showDialog('new_habit')" style="margin-bottom: 24px; align-items: center; padding: 30px; cursor: pointer;">
            <div style="font-size: 3rem; line-height: 1;">+</div>
            <div style="font-weight: 700; margin-top: 10px;">åˆ›å»ºæ–°ä¹ æƒ¯</div>
        </div>
        <h2>è¿›è¡Œä¸­</h2>
        <div id="manage-active-list" class="card-list"></div>
        <h2 style="margin-top:40px; opacity:0.5;">å½’æ¡£ç®±</h2>
        <details><summary>å·²å½’æ¡£çš„ä¹ æƒ¯ <span id="archive-count">0</span></summary><div id="manage-archive-list" class="archived-list"></div></details>
        <div class="card" style="margin-top:40px; background:#eee;" onclick="UI.showDialog('export')"><div style="font-weight:700; text-align:center;">ğŸ“¤ å¤‡ä»½æ•°æ® (å¯¼å‡º)</div></div>
        <div class="card" style="margin-top:10px; background:#eee;" onclick="UI.showDialog('import')"><div style="font-weight:700; text-align:center;">ğŸ“¥ æ¢å¤æ•°æ® (å¯¼å…¥)</div></div>
    </div>

    <div id="page-profile" class="page">
        <h1>æˆ‘çš„æˆå°±</h1>
        <div class="card-list">
            <div class="card" style="flex-direction: row; align-items: center; gap: 20px; padding: 20px;">
                <div style="width: 60px; height: 60px; border-radius: 50%; overflow:hidden; background: #000; color:white; display:flex; justify-content:center; align-items:center; font-size:2rem;">â˜»</div>
                <div><div style="font-weight: 900; font-size: 1.5rem;">Habit User</div><div style="font-size: 0.9rem; color: #999;" id="total-stats">ç»Ÿè®¡åŠ è½½ä¸­...</div></div>
            </div>
            <div class="card">
                <div class="badge-header"><h3>é‡Œç¨‹ç¢‘ Milestones</h3><div class="badge-toggle-btn" onclick="UI.openStackView('milestone')">æŸ¥çœ‹å…¨éƒ¨</div></div>
                <div class="badge-preview-grid" id="milestone-preview"></div>
            </div>
            <div class="card">
                <div class="badge-header"><h3>ç‰¹æ®Šæˆå°± Achievements</h3><div class="badge-toggle-btn" onclick="UI.openStackView('achievement')">æŸ¥çœ‹å…¨éƒ¨</div></div>
                <div class="badge-preview-grid" id="achievement-preview"></div>
            </div>
            <div class="card" onclick="UI.showDialog('reset')" style="background:#eee; color:#FF3B30; align-items:center; padding:15px;"><div style="font-weight:700;">âš  æ¸…ç©ºæ‰€æœ‰æ•°æ®</div></div>
            <div class="card" onclick="UI.showDialog('contact')" style="background:#eee; color:#333; align-items:center; padding:15px; margin-top: -10px;"><div style="font-weight:700;">ğŸ’¬ å­¦ä¹ äº¤æµåŒº</div></div>
        </div>
    </div>

    <div id="achievements-overlay" class="stack-overlay">
        <div class="stack-header">
            <div class="stack-title-row">
                <div class="stack-title" id="stack-view-title">ACHIEVEMENTS</div>
                <div class="stack-count" id="stack-view-count">0/0</div>
            </div>
            <div class="stack-progress-bg"><div class="stack-progress-bar" id="stack-progress"></div></div>
        </div>
        <div class="stack-scroll-area" id="stack-list" onscroll="UI.updateStackProgress(this)"></div>
        <div class="stack-close-fab" onclick="UI.closeStackView()">âœ•</div>
    </div>

    <div id="habit-modal" class="modal">
        <div class="modal-header"><h2 id="modal-title" style="margin:0; font-size:2rem;"></h2><div class="close-btn" onclick="UI.closeModal()">âœ•</div></div>
        <div class="modal-content">
            <div class="view-toggle"><div class="view-btn active" onclick="UI.switchView('grid')" id="btn-view-grid">è¿‘æœŸè§†å›¾</div><div class="view-btn" onclick="UI.switchView('year')" id="btn-view-year">å¹´åº¦è§†å›¾</div></div>
            <div id="view-grid-container">
                <div class="card full" id="modal-heatmap-card" style="min-height:200px; justify-content:center; margin-bottom:15px; align-items:center;">
                    <div class="recent-grid" id="modal-recent-grid"></div>
                    <div class="label" style="text-align:center; margin-top:15px;">è¿‘14å¤©çŠ¶æ€</div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="card bg-taro"><div class="label">å½“å‰è¿èƒœ</div><div class="big-num" id="modal-streak">0</div></div>
                    <div class="card" style="background:#eee;"><div class="label">å†å²ç´¯è®¡</div><div class="big-num" id="modal-total" style="color:#999;">0</div></div>
                </div>
            </div>
            <div id="view-year-container" style="display:none;">
                <div class="year-tabs-container" id="year-tabs"></div>
                <div class="card full" style="overflow:hidden; margin-bottom:20px;">
                    <div class="year-grid-container"><div class="year-grid" id="year-heatmap"></div></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="label">å¹´åº¦å®Œæˆç‡</div><div class="stat-val" id="stat-year-rate">0%</div></div>
                    <div class="stat-card"><div class="label">æœ€é•¿è¿èƒœ</div><div class="stat-val" id="stat-year-streak">0</div></div>
                    <div class="stat-card"><div class="label">æœˆå‡æ‰“å¡</div><div class="stat-val" id="stat-year-avg">0</div></div>
                    <div class="stat-card"><div class="label">è¯¥å¹´æ€»è®¡</div><div class="stat-val" id="stat-year-total">0</div></div>
                </div>
                <div class="card full" style="margin-top:20px; background:#333; color:white;">
                    <div class="label" style="opacity:0.6;">ç”Ÿæ¶¯æ±‡æ€»</div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                        <div><div style="font-size:2rem; font-weight:900;" id="stat-life-days">0</div><div style="font-size:0.8rem; opacity:0.6;">è‡ª <span id="stat-life-start">--</span></div></div>
                        <div style="text-align:right;"><div style="font-size:2rem; font-weight:900;" id="stat-life-total">0</div><div style="font-size:0.8rem; opacity:0.6;">æ€»æ‰“å¡æ¬¡æ•°</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="check-btn-container" id="check-btn-container"><button id="btn-checkin" class="big-check-btn" onclick="Core.handleModalCheckIn()"><span>âšª</span> ç«‹å³æ‰“å¡</button></div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="UI.switchTab('tracker', this)"><div class="tab-icon" style="background: var(--c-lemon);"></div><span>åˆ—è¡¨</span></div>
        <div class="tab-item" onclick="UI.switchTab('manage', this)"><div class="tab-icon" style="background: var(--c-taro);"></div><span>ç®¡ç†</span></div>
        <div class="tab-item" onclick="UI.switchTab('profile', this)"><div class="tab-icon" style="background: var(--c-blue);"></div><span>æˆ‘çš„</span></div>
    </nav>

    <div id="custom-dialog" class="dialog-overlay" onclick="UI.closeDialog(event)"><div class="dialog-card" onclick="event.stopPropagation()"><div id="dialog-content"></div></div></div>
    <div id="toast" class="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
</div>

<script>
    /**
     * V2.3 Neon Stack
     */

    const Config = {
        colors: ['bg-lemon', 'bg-taro', 'bg-blue', 'bg-pink', 'bg-orange', 'bg-green'],
        colorHex: ['#EBFF00', '#C8B6FF', '#4A90E2', '#FF2D55', '#FF9500', '#34C759'],
        icons: {
            first_blood: '<svg viewBox="0 0 24 24"><path d="M12 2C8.69 2 6 4.69 6 8v12c0 .55.45 1 1 1h10c.55 0 1-.45 1-1V8c0-3.31-2.69-6-6-6zm-2 8h4v2h-4v-2z"/></svg>',
            early_bird: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 2V4M12 20V22M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M2 12H4M20 12H22M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            night_owl: '<svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>',
            double_kill: '<svg viewBox="0 0 24 24"><path d="M2 12l5 5 8-8M9 12l5 5 8-8" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>',
            triple_kill: '<svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>',
            perfect_week: '<svg viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>',
            perfect_month: '<svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>',
            weekend_warrior: '<svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>',
            phoenix: '<svg viewBox="0 0 24 24"><path d="M12 2C8 2 4 6 4 12c0 4 3 8 8 8s8-4 8-8-4-10-8-10zm0 14c-2 0-4-2-4-4 0-1.5.8-2.8 2-3.5-.5 1 .2 2.5 2 2.5s2.5-1.5 2-2.5c1.2.7 2 2 2 3.5 0 2-2 4-4 4z"/></svg>',
            minimalist: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8 9h2V7h-2v5zm0 4h2v-2h-2v2z"/></svg>',
            habit_master: '<svg viewBox="0 0 24 24"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>',
            cleaner: '<svg viewBox="0 0 24 24"><path d="M15 16l-4 4h8v-4h-4zm-2.94-8.81l2.77-2.77c.2-.2.2-.51 0-.71l-3.54-3.54c-.2-.2-.51-.2-.71 0l-2.77 2.77c-.2.2-.2.51 0 .71l3.54 3.54c.2.2.51.2.71 0zm-7.6 7.6l6.83 6.83c.78.78 2.05.78 2.83 0l6.83-6.83c.78-.78.78-2.05 0-2.83l-3.32-3.32-9.66 9.66-3.51-3.51z"/></svg>'
        },
        milestones: [3, 7, 21, 30, 60, 100, 180, 365, 500, 800, 1000, 3000],
        achievements: [
            { id: 'first_blood', name: 'åˆå‡ºèŒ…åº', desc:'å®Œæˆç¬¬1æ¬¡æ‰“å¡' },
            { id: 'early_bird', name: 'æ—©èµ·é¸Ÿ', desc:'è¿ç»­5å¤©åœ¨08:00å‰æ‰“å¡' },
            { id: 'night_owl', name: 'å¤œçŒ«å­', desc:'è¿ç»­3å¤©åœ¨23:00åæ‰“å¡' },
            { id: 'double_kill', name: 'åŒå“ç‚®', desc:'å•æ—¥å®Œæˆ2ä¸ªä¹ æƒ¯' },
            { id: 'triple_kill', name: 'ä¸‰è¿å‡»', desc:'å•æ—¥å®Œæˆ3ä¸ªä¹ æƒ¯' },
            { id: 'perfect_week', name: 'å®Œç¾å‘¨', desc:'è¿‡å»7å¤©æ¯å¤©éƒ½æœ‰æ‰“å¡' },
            { id: 'perfect_month', name: 'å®Œç¾æœˆ', desc:'è¿‡å»30å¤©æ¯å¤©éƒ½æœ‰æ‰“å¡' },
            { id: 'weekend_warrior', name: 'å‘¨æœ«æˆ˜å£«', desc:'è¿ç»­4ä¸ªå‘¨æœ«æ— ç¼ºå¸­' },
            { id: 'phoenix', name: 'æµ´ç«é‡ç”Ÿ', desc:'æ–­ç­¾åé‡æ–°è¿ç»­æ‰“å¡3å¤©' },
            { id: 'minimalist', name: 'æç®€ä¸»ä¹‰', desc:'ä½¿ç”¨è¿‡å½’æ¡£åŠŸèƒ½' },
            { id: 'habit_master', name: 'ä¹ æƒ¯å¤§å¸ˆ', desc:'æ‹¥æœ‰5ä¸ªåŠä»¥ä¸Šè¿›è¡Œä¸­çš„ä¹ æƒ¯' },
            { id: 'cleaner', name: 'æ–­èˆç¦»', desc:'åˆ é™¤è¿‡ä¸€ä¸ªä¹ æƒ¯' }
        ]
    };

    const Store = {
        habits: [],
        permAchieve: { first_blood: false, minimalist: false, cleaner: false },
        init() {
            const h = localStorage.getItem('habit_v6_data');
            const p = localStorage.getItem('habit_v6_perm');
            if(h) this.habits = JSON.parse(h);
            if(p) this.permAchieve = JSON.parse(p);
            if(!h && !p) this.habits = [{ id: 1, name: "æ—©èµ·", created: Core.getTodayStr(), archived: false, history: {} }];
            UI.renderAll();
        },
        save() {
            localStorage.setItem('habit_v6_data', JSON.stringify(this.habits));
            localStorage.setItem('habit_v6_perm', JSON.stringify(this.permAchieve));
            UI.renderAll();
        },
        addHabit(name) {
            this.habits.push({id: Date.now(), name, created: Core.getTodayStr(), archived: false, history: {}});
            this.save();
        },
        deleteHabit(id) {
            this.habits = this.habits.filter(h => h.id !== id);
            this.permAchieve.cleaner = true;
            this.save();
        },
        toggleArchive(id) {
            const h = this.habits.find(i => i.id === id);
            if(h) {
                h.archived = !h.archived;
                if(h.archived) this.permAchieve.minimalist = true;
                this.save();
            }
        },
        reset() { localStorage.clear(); location.reload(); }
    };

    const Core = {
        todayStr: '',
        init() {
            const d = new Date();
            this.todayStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        },
        getTodayStr() { return this.todayStr; },
        calculateStats(h) {
            let streak = 0; let d = new Date();
            if(!h.history[this.todayStr]) d.setDate(d.getDate() - 1);
            const fmt = date => `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            while(h.history[fmt(d)]) { streak++; d.setDate(d.getDate() - 1); }
            return { streak, total: Object.keys(h.history).length };
        },
        handleModalCheckIn() {
            if(!UI.currentHabitId) return;
            const h = Store.habits.find(i => i.id === UI.currentHabitId);
            if(h.history[this.todayStr]) delete h.history[this.todayStr];
            else {
                h.history[this.todayStr] = new Date().toTimeString().slice(0,5);
                Store.permAchieve.first_blood = true;
            }
            Store.save();
            UI.updateModalContent();
        },
        checkStatus() {
            const habits = Store.habits;
            const today = this.todayStr;
            const checkGlobal = (days) => {
                for(let i=0; i<days; i++){
                    const d=new Date(); d.setDate(d.getDate()-i);
                    const k = d.toISOString().split('T')[0];
                    if(!habits.some(h => !!h.history[k])) return false;
                } return true;
            };
            const checkTime = (days, startHour, endHour) => {
               for(let i=0; i<days; i++){
                   const d=new Date(); d.setDate(d.getDate()-i);
                   const k = d.toISOString().split('T')[0];
                   let hit = false;
                   for(let h of habits) {
                       if(h.history[k]) {
                           if(startHour && h.history[k] < startHour) hit = true;
                           if(endHour && h.history[k] >= endHour) hit = true;
                       }
                   }
                   if(!hit) return false;
               } return true;
            };
            const dailyCount = habits.filter(h => !!h.history[today]).length;
            return {
                first_blood: Store.permAchieve.first_blood,
                early_bird: checkTime(5, "08:00", null),
                night_owl: checkTime(3, null, "23:00"),
                double_kill: dailyCount >= 2,
                triple_kill: dailyCount >= 3,
                perfect_week: checkGlobal(7),
                perfect_month: checkGlobal(30),
                phoenix: habits.some(h => {
                    const s = this.calculateStats(h);
                    if(s.streak < 3) return false;
                    const d = new Date(); d.setDate(d.getDate() - s.streak);
                    return !h.history[d.toISOString().split('T')[0]];
                }),
                weekend_warrior: (() => {
                     let w=0; let d=new Date();
                     while(w<8){
                         const day=d.getDay();
                         if(day===0||day===6){
                             const k=d.toISOString().split('T')[0];
                             if(!habits.some(h=>!!h.history[k])) return false;
                             w++;
                         }
                         d.setDate(d.getDate()-1);
                         if((new Date()-d)>3456000000) break;
                     } return true;
                })(),
                minimalist: Store.permAchieve.minimalist,
                habit_master: habits.filter(h=>!h.archived).length >= 5,
                cleaner: Store.permAchieve.cleaner
            };
        }
    };

    const UI = {
        currentHabitId: null,
        selectedYearMode: 'rolling',
        pendingDeleteId: null,

        init() {
            // Icon Gen
            const c = document.createElement('canvas'); c.width=512; c.height=512; const ctx=c.getContext('2d');
            ctx.fillStyle='#2C2C2E'; ctx.fillRect(0,0,512,512);
            const g=ctx.createLinearGradient(100,256,412,256); g.addColorStop(0,'#EBFF00'); g.addColorStop(0.5,'#C8B6FF'); g.addColorStop(1,'#4A90E2');
            ctx.strokeStyle=g; ctx.lineWidth=40; ctx.lineCap='round'; ctx.lineJoin='round';
            ctx.beginPath(); ctx.moveTo(256,256);
            ctx.bezierCurveTo(356,156,456,156,456,256); ctx.bezierCurveTo(456,356,356,356,256,256);
            ctx.bezierCurveTo(156,156,56,156,56,256); ctx.bezierCurveTo(56,356,156,356,256,256); ctx.stroke();
            document.getElementById('dynamic-icon').href=c.toDataURL('image/png');
        },

        renderAll() { this.renderTracker(); this.renderManage(); this.renderProfile(); },

        renderTracker() {
            const list = document.getElementById('habit-list');
            const empty = document.getElementById('empty-state');
            list.innerHTML = '';
            const active = Store.habits.filter(h => !h.archived);
            if(active.length === 0) { empty.style.display='block'; return; } 
            empty.style.display='none';
            
            active.forEach((h, idx) => {
                const color = Config.colors[idx % Config.colors.length];
                const stats = Core.calculateStats(h);
                const isDone = !!h.history[Core.todayStr];
                list.innerHTML += `
                <div class="card full ${color}" onclick="UI.openModal(${h.id})" style="cursor:pointer;">
                    <div class="list-card-header"><span class="habit-name">${h.name}</span><span style="background:rgba(0,0,0,0.1); padding:5px 10px; border-radius:20px; font-weight:700; font-size:0.8rem;">${isDone ? 'å·²å®Œæˆ' : 'å»æ‰“å¡'}</span></div>
                    <div class="mini-stats"><div class="mini-stat-item"><span class="mini-stat-val">${stats.streak}</span><span class="mini-stat-lbl">STREAK</span></div><div class="mini-stat-item" style="opacity:0.6;"><span class="mini-stat-val">${stats.total}</span><span class="mini-stat-lbl">TOTAL</span></div></div>
                </div>`;
            });
        },

        renderManage() {
            const activeEl = document.getElementById('manage-active-list');
            const archEl = document.getElementById('manage-archive-list');
            activeEl.innerHTML=''; archEl.innerHTML='';
            let arcCount = 0;
            
            Store.habits.forEach(h => {
                const html = `
                <div class="card" style="padding:20px; margin-bottom:10px; flex-direction:row; justify-content:space-between; align-items:center;">
                    <div style="font-weight:800; ${h.archived?'opacity:0.5':''}">${h.name}</div>
                    <div style="display:flex; gap:10px;">
                        <div style="background:#eee; padding:8px 15px; border-radius:20px; font-size:0.8rem; font-weight:700;" onclick="Store.toggleArchive(${h.id})">${h.archived?'æ¢å¤':'å½’æ¡£'}</div>
                        ${h.archived ? `<div style="background:#ffebeb; color:red; padding:8px 15px; border-radius:20px; font-size:0.8rem;" onclick="UI.showDialog('delete_confirm', ${h.id})">åˆ é™¤</div>` : ''}
                    </div>
                </div>`;
                if(h.archived) { archEl.innerHTML += html; arcCount++; } else activeEl.innerHTML += html;
            });
            document.getElementById('archive-count').innerText = arcCount;
        },

        renderProfile() {
            const habits = Store.habits;
            let total = 0; habits.forEach(h => total += Object.keys(h.history).length);
            document.getElementById('total-stats').innerText = `ç´¯è®¡æ‰“å¡: ${total}`;

            const mGrid = document.getElementById('milestone-preview'); mGrid.innerHTML = '';
            for(let i=0; i<4; i++) {
                const num = Config.milestones[i];
                const unlocked = total >= num;
                const style = unlocked ? 'color:#FFD700; background:#000 !important;' : '';
                mGrid.innerHTML += `<div class="badge-preview ${unlocked?'unlocked':''}" style="${style}"><div style="font-weight:900;">${num}</div></div>`;
            }

            const aGrid = document.getElementById('achievement-preview'); aGrid.innerHTML = '';
            const status = Core.checkStatus();
            for(let i=0; i<4; i++) {
                const ach = Config.achievements[i];
                const unlocked = status[ach.id];
                const bg = Config.colorHex[i % Config.colorHex.length];
                const style = unlocked ? `background:${bg} !important; color:#000;` : '';
                aGrid.innerHTML += `<div class="badge-preview ${unlocked?'unlocked':''}" style="${style}">${Config.icons[ach.id]}</div>`;
            }
        },

        // --- V2.3 Sorted Logic & Neon Visual ---
        openStackView(type) {
            let title = ''; let html = ''; let count = 0; let totalCount = 0;
            let totalGlobal = 0; Store.habits.forEach(h => totalGlobal += Object.keys(h.history).length);
            const status = Core.checkStatus();
            
            // æ’åºé€»è¾‘ï¼šUnLocked > Locked
            let data = [];
            if(type === 'milestone') {
                title = 'MILESTONES';
                totalCount = Config.milestones.length;
                data = Config.milestones.map((m, idx) => ({ 
                    val: m, 
                    unlocked: totalGlobal >= m,
                    color: Config.colorHex[idx % Config.colorHex.length],
                    idx: idx 
                }));
            } else {
                title = 'ACHIEVEMENTS';
                totalCount = Config.achievements.length;
                data = Config.achievements.map((a, idx) => ({
                    ...a,
                    unlocked: status[a.id],
                    color: Config.colorHex[idx % Config.colorHex.length],
                    idx: idx
                }));
            }
            
            // æ‰§è¡Œæ’åº
            data.sort((a,b) => (b.unlocked - a.unlocked)); 
            count = data.filter(i=>i.unlocked).length;

            data.forEach((item, i) => {
                const unlocked = item.unlocked;
                const bg = item.color; // å›ºæœ‰é¢œè‰²
                
                // è§†è§‰ç±»å
                const cls = unlocked ? 'unlocked' : 'locked';
                // æœªè§£é”ï¼šä¿æŒåŸè‰²ä¿¡æ¯ç”¨äºè¾¹æ¡†
                const style = unlocked ? `background:${bg}` : `color:${bg}`; 
                const watermark = String(i+1).padStart(2,'0');

                if(type === 'milestone') {
                    html += `
                    <div class="stack-card ${cls}" style="${style}; z-index:${i+1};">
                        <div class="stk-head">
                            <div class="stk-icon" style="background:#000; color:${bg}">${item.val}</div>
                            <div class="stk-tag">${unlocked ? 'UNLOCKED' : 'LOCKED'}</div>
                        </div>
                        <div class="stk-body">
                            <div class="stk-name">ç´¯è®¡æ‰“å¡<br>${item.val}æ¬¡</div>
                            <div class="stk-desc">å½“å‰è¿›åº¦: ${totalGlobal} / ${item.val}</div>
                            <div class="stk-watermark">${watermark}</div>
                        </div>
                    </div>`;
                } else {
                    html += `
                    <div class="stack-card ${cls}" style="${style}; z-index:${i+1};">
                        <div class="stk-head">
                            <div class="stk-icon" style="background:#000; color:${bg}">${Config.icons[item.id]}</div>
                            <div class="stk-tag">${unlocked ? 'UNLOCKED' : 'LOCKED'}</div>
                        </div>
                        <div class="stk-body">
                            <div class="stk-name">${item.name}</div>
                            <div class="stk-desc">${item.desc}<br>çŠ¶æ€: ${unlocked ? 'å·²è§£é”' : 'æœªè§£é”'}</div>
                            <div class="stk-watermark">${watermark}</div>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('stack-view-title').innerText = title;
            document.getElementById('stack-view-count').innerText = `${count}/${totalCount}`;
            document.getElementById('stack-list').innerHTML = html;
            document.getElementById('achievements-overlay').classList.add('open');
            this.updateStackProgress(document.getElementById('stack-list')); // init progress
        },
        closeStackView() { document.getElementById('achievements-overlay').classList.remove('open'); },
        
        // Progress Bar Logic
        updateStackProgress(el) {
            const h = el.scrollHeight - el.clientHeight;
            const w = (el.scrollTop / h) * 100;
            document.getElementById('stack-progress').style.width = Math.min(100, Math.max(0, w)) + '%';
        },

        // Modal Logic
        openModal(id) {
            this.currentHabitId = id; this.selectedYearMode = 'rolling';
            this.switchView('grid'); this.updateModalContent();
            document.getElementById('habit-modal').classList.add('open');
        },
        closeModal() { document.getElementById('habit-modal').classList.remove('open'); this.currentHabitId = null; },
        switchView(mode) {
            document.getElementById('view-grid-container').style.display = mode==='grid'?'block':'none';
            document.getElementById('view-year-container').style.display = mode==='year'?'block':'none';
            document.getElementById('btn-view-grid').className = mode==='grid'?'view-btn active':'view-btn';
            document.getElementById('btn-view-year').className = mode==='year'?'view-btn active':'view-btn';
            document.getElementById('check-btn-container').style.display = mode==='grid'?'flex':'none';
            if(mode==='year') { this.renderYearTabs(); this.renderYearView(); }
        },
        updateModalContent() {
            if(!this.currentHabitId) return;
            const h = Store.habits.find(i=>i.id===this.currentHabitId);
            const stats = Core.calculateStats(h);
            const isDone = !!h.history[Core.todayStr];
            const color = Config.colors[Store.habits.indexOf(h) % Config.colors.length];
            
            document.getElementById('modal-title').innerText = h.name;
            document.getElementById('modal-streak').innerText = stats.streak;
            document.getElementById('modal-total').innerText = stats.total;
            document.getElementById('modal-heatmap-card').className = `card full ${color}`;
            
            const grid = document.getElementById('modal-recent-grid'); grid.innerHTML='';
            for(let i=13; i>=0; i--){
                const d=new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().split('T')[0];
                const active = !!h.history[k];
                const isToday = (k === Core.todayStr);
                grid.innerHTML += `<div class="recent-block ${active?'active':''} ${isToday&&!active?'today':''}" style="background:${active?'rgba(0,0,0,0.2)':'rgba(0,0,0,0.05)'}; color:${active?'rgba(0,0,0,0.5)':'rgba(0,0,0,0.2)'}">${d.getDate()}</div>`;
            }
            const btn = document.getElementById('btn-checkin');
            if(isDone) { btn.classList.add('checked'); btn.innerHTML='<span>âœ“</span> ä»Šæ—¥å·²å®Œæˆ'; } 
            else { btn.classList.remove('checked'); btn.innerHTML='<span>âšª</span> ç«‹å³æ‰“å¡'; }
            if(document.getElementById('view-year-container').style.display==='block') this.renderYearView();
        },
        
        // Year View Logic
        renderYearTabs() {
            const h = Store.habits.find(i=>i.id===this.currentHabitId);
            const tabs = document.getElementById('year-tabs'); tabs.innerHTML = '';
            tabs.innerHTML += `<div class="year-tab ${this.selectedYearMode==='rolling'?'active':''}" onclick="UI.switchYearMode('rolling')">è¿‘ä¸€å¹´</div>`;
            const startY = new Date(h.created).getFullYear();
            const nowY = new Date().getFullYear();
            for(let y=nowY; y>=startY; y--) tabs.innerHTML += `<div class="year-tab ${this.selectedYearMode===y?'active':''}" onclick="UI.switchYearMode(${y})">${y}</div>`;
        },
        switchYearMode(m) { this.selectedYearMode = m; this.renderYearTabs(); this.renderYearView(); },
        renderYearView() {
            const h = Store.habits.find(i=>i.id===this.currentHabitId);
            const container = document.getElementById('year-heatmap'); container.innerHTML='';
            const colorClass = Config.colors[Store.habits.indexOf(h) % Config.colors.length];
            const activeColor = Config.colorHex[Config.colors.indexOf(colorClass)] || '#000';
            
            let start, end;
            if(this.selectedYearMode === 'rolling') { end=new Date(); start=new Date(); start.setDate(end.getDate()-364); } 
            else { start=new Date(this.selectedYearMode,0,1); end=new Date(this.selectedYearMode,11,31); if(end>new Date()) end=new Date(); }
            if(start < new Date(h.created)) start = new Date(h.created);

            let d = new Date(start); let activeCount=0; let maxStreak=0; let curStreak=0; let totalDays=0;
            let lastM = -1;
            
            while(d <= end) {
                const k = d.toISOString().split('T')[0];
                const active = !!h.history[k];
                if(lastM !== -1 && d.getMonth() !== lastM) container.innerHTML += `<div class="month-separator"></div>`;
                container.innerHTML += `<div class="year-dot" style="background:${active ? activeColor : '#eee'}"></div>`;
                
                totalDays++;
                if(active) { activeCount++; curStreak++; maxStreak=Math.max(maxStreak, curStreak); } else curStreak=0;
                lastM = d.getMonth(); d.setDate(d.getDate()+1);
            }
            setTimeout(()=> document.querySelector('.year-grid-container').scrollLeft = 10000, 50);
            
            document.getElementById('stat-year-rate').innerText = (totalDays>0 ? Math.round((activeCount/totalDays)*100) : 0) + '%';
            document.getElementById('stat-year-streak').innerText = maxStreak;
            document.getElementById('stat-year-avg').innerText = (activeCount/Math.max(1,totalDays/30)).toFixed(1);
            document.getElementById('stat-year-total').innerText = activeCount;
            const daysLife = Math.floor((new Date()-new Date(h.created))/(86400000))+1;
            document.getElementById('stat-life-days').innerText = daysLife + ' å¤©';
            document.getElementById('stat-life-start').innerText = h.created;
            document.getElementById('stat-life-total').innerText = Object.keys(h.history).length;
        },

        switchTab(p,el) {
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
        },
        showDialog(type, data) {
            let html = ''; const d = document.getElementById('custom-dialog'); const c = document.getElementById('dialog-content');
            if(type === 'new_habit') {
                html = `<div class="dialog-title">åˆ›å»ºæ–°ä¹ æƒ¯</div><input type="text" id="d-input" class="dialog-input" placeholder="ä¾‹å¦‚ï¼šæ—©èµ·æ™¨è·‘" autofocus><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="UI.closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-confirm" onclick="UI.confirmNew()">ç¡®å®š</button></div>`;
            } else if(type === 'delete_confirm') {
                this.pendingDeleteId = data;
                html = `<div class="dialog-title">åˆ é™¤ä¹ æƒ¯</div><div class="dialog-desc" style="color:#FF3B30;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</div><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="UI.closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-danger" onclick="UI.execDelete()">åˆ é™¤</button></div>`;
            } else if(type === 'export') {
                const str = JSON.stringify({h:Store.habits, p:Store.permAchieve});
                window.tmpExp = str;
                html = `<div class="dialog-title">å¤‡ä»½æ•°æ®</div><div class="dialog-desc">ä¿å­˜ä¸ºæ–‡ä»¶æœ€å®‰å…¨ï¼š</div><div class="dialog-btn-vertical"><button class="dialog-btn btn-action" onclick="IO.copyExp()">ğŸ“‹ å¤åˆ¶æ•°æ®ä»£ç </button><button class="dialog-btn btn-action-outline" onclick="IO.downExp()">ğŸ’¾ å¯¼å‡ºä¸º .txt æ–‡ä»¶</button></div><button class="dialog-btn btn-cancel" style="margin-top:15px" onclick="UI.closeDialog()">å…³é—­</button>`;
            } else if(type === 'import') {
                html = `<div class="dialog-title">æ¢å¤æ•°æ®</div><div class="dialog-desc" style="color:red;">âš ï¸ å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼</div><button class="dialog-btn btn-action" onclick="document.getElementById('import-file').click()">ğŸ“‚ é€‰æ‹©å¤‡ä»½æ–‡ä»¶...</button><div class="dialog-divider" style="margin:10px 0; font-size:0.8rem; color:#999;">æˆ–ç²˜è´´ä»£ç </div><textarea id="d-text" class="dialog-textarea"></textarea><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="UI.closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-confirm" onclick="IO.confirmImp()">æ¢å¤</button></div>`;
            } else if(type === 'contact') {
                html = `<div class="dialog-title">åˆ¶ä½œè€…å¾®ä¿¡</div><div class="dialog-desc" style="font-size:1.5rem; font-weight:900; color:var(--c-blue); margin:20px 0; cursor:pointer;" onclick="IO.copyTxt('Glimmer-0000')">Glimmer-0000</div><div class="dialog-desc" style="font-size:0.8rem;">ä¸€èµ·äº¤æµä¹ æƒ¯å…»æˆ</div><button class="dialog-btn btn-confirm" onclick="UI.closeDialog()">å…³é—­</button>`;
            } else if(type === 'reset') {
                html = `<div class="dialog-title">æ¸…ç©ºæ•°æ®</div><div class="dialog-desc" style="color:#FF3B30;">æ°¸ä¹…åˆ é™¤æ‰€æœ‰è®°å½•ï¼</div><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="UI.closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-danger" onclick="Store.reset()">æ¸…ç©º</button></div>`;
            }
            c.innerHTML = html; d.style.display = 'flex';
            const inp = document.getElementById('d-input'); if(inp) setTimeout(()=>inp.focus(), 100);
        },
        closeDialog(e) { if(e) e.stopPropagation(); document.getElementById('custom-dialog').style.display='none'; this.pendingDeleteId=null; },
        confirmNew() { const v = document.getElementById('d-input').value; if(v) { Store.addHabit(v); this.closeDialog(); } },
        execDelete() { if(this.pendingDeleteId) { Store.deleteHabit(this.pendingDeleteId); this.closeDialog(); } }
    };

    const IO = {
        copyExp() { this.copyTxt(window.tmpExp); UI.closeDialog(); },
        downExp() { const b = new Blob([window.tmpExp],{type:'text/plain'}); const u = URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`Habit_Backup_${Core.todayStr}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); UI.closeDialog(); },
        handleFileSelect(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => this.processImp(e.target.result); r.readAsText(f); input.value=''; },
        confirmImp() { const v = document.getElementById('d-text').value; if(v) this.processImp(v); },
        processImp(json) { try { const d = JSON.parse(json); if(d.h) { Store.habits=d.h; Store.permAchieve=d.p||Store.permAchieve; Store.save(); alert("æ¢å¤æˆåŠŸ"); location.reload(); } else alert("æ•°æ®æ ¼å¼é”™"); } catch(e){ alert("æ–‡ä»¶æŸå"); } },
        copyTxt(t) { navigator.clipboard.writeText(t).then(()=>{ const el=document.getElementById('toast'); el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }); }
    };

    Core.init(); UI.init(); Store.init();
</script>
</body>
</html>
