<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Habit Tracker V6.1</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #000000;
            --text-sub: #8E8E93;
            /* é…è‰² */
            --c-lemon: #EBFF00;
            --c-taro: #C8B6FF;
            --c-blue: #4A90E2;
            --c-green: #34C759;
            --c-pink: #FF2D55;
            --c-orange: #FF9500;
            --radius-box: 24px;
            --radius-s: 12px;
            --nav-height: 80px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: auto !important; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        .app-container { flex: 1; position: relative; overflow: hidden; max-width: 450px; margin: 0 auto; width: 100%; background: var(--bg-color); }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: calc(var(--safe-area-top) + 20px) 20px calc(var(--nav-height) + 40px) 20px;
            display: none; scrollbar-width: none;
        }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        .page::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 3rem; font-weight: 900; margin: 10px 0 30px 0; line-height: 1; letter-spacing: -0.03em; }
        h2 { font-size: 1.5rem; font-weight: 800; margin: 30px 0 15px 0; }
        h3 { font-size: 1.1rem; font-weight: 800; margin: 0; }

        .card-list { display: flex; flex-direction: column; gap: 20px; }
        .card {
            background: var(--card-bg); border-radius: var(--radius-box); padding: 25px;
            position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); transition: transform 0.1s;
        }
        .card.full { width: 100%; }
        
        .bg-lemon { background-color: var(--c-lemon); }
        .bg-taro { background-color: var(--c-taro); }
        .bg-blue { background-color: var(--c-blue); color: white; }
        .bg-green { background-color: var(--c-green); color: white; }
        .bg-pink { background-color: var(--c-pink); color: white; }
        .bg-orange { background-color: var(--c-orange); }

        .big-num { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: -0.05em; }
        .label { font-size: 0.8rem; font-weight: 700; opacity: 0.7; text-transform: uppercase; margin-top: auto; }

        .list-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .habit-name { font-size: 1.8rem; font-weight: 800; line-height: 1.1; }
        .mini-stats { display: flex; gap: 20px; }
        .mini-stat-item { display: flex; flex-direction: column; }
        .mini-stat-val { font-size: 1.5rem; font-weight: 900; }
        .mini-stat-lbl { font-size: 0.7rem; font-weight: 600; opacity: 0.6; }

        /* åº•éƒ¨è¯¦æƒ…å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000;
            display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: calc(var(--safe-area-top) + 20px) 20px 40px 20px;
        }
        .modal.open { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; cursor: pointer; }
        .modal-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scrollbar-width: none; padding-bottom: 40px; }
        
        .view-toggle { display: flex; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 12px; margin-bottom: 10px; flex-shrink: 0; }
        .view-btn { flex: 1; padding: 8px; text-align: center; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #999; }
        .view-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* è¿‘æœŸè§†å›¾ */
        .recent-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; }
        .recent-block { 
            width: 100%; aspect-ratio: 1; border-radius: 8px; background: rgba(0,0,0,0.05); 
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; font-weight: 700; color: rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .recent-block.active { box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: rgba(0,0,0,0.5); }
        .recent-block.today { border: 2px solid rgba(0,0,0,0.1); }

        /* å¹´åº¦è§†å›¾ */
        .year-tabs-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .year-tab { padding: 6px 16px; background: #eee; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #999; flex-shrink: 0; transition: all 0.2s; }
        .year-tab.active { background: black; color: white; }
        .year-grid-container { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .year-grid { display: grid; grid-template-rows: repeat(7, 10px); grid-auto-flow: column; gap: 3px; width: max-content; }
        .year-dot { width: 10px; height: 10px; background: #eee; border-radius: 2px; }
        .month-separator { width: 1px; height: 100%; background: rgba(0,0,0,0.1); margin: 0 2px; grid-row: 1 / -1; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: #fff; border-radius: var(--radius-s); padding: 15px; display: flex; flex-direction: column; justify-content: space-between; min-height: 100px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .stat-val { font-size: 1.8rem; font-weight: 900; line-height: 1; }
        .stat-lbl { font-size: 0.7rem; font-weight: 700; color: #999; margin-top: 5px; }

        .check-btn-container { margin-top: auto; padding-top: 20px; flex-shrink: 0; }
        .big-check-btn {
            width: 100%; height: 80px; border-radius: 40px; border: none; background: #000; color: #fff; 
            font-size: 1.5rem; font-weight: 800; display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .big-check-btn:active { transform: scale(0.95); }
        .big-check-btn.checked { background: var(--c-green); color: white; }

        /* å¾½ç« å¢™ */
        .badge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .badge-toggle-btn { font-size: 0.8rem; font-weight: 700; color: var(--c-blue); cursor: pointer; }
        .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; height: auto; overflow: hidden; }
        .badge-grid.collapsed { height: 90px; }
        .badge { aspect-ratio: 1; background: #eee; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0.3; filter: grayscale(1); transition: all 0.5s; }
        .badge.unlocked { opacity: 1; filter: grayscale(0); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .badge-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .badge-text { font-size: 0.6rem; font-weight: 700; color: #666; text-align: center; line-height: 1; }
        .badge.gold { background: linear-gradient(135deg, #FFF 0%, #FFD700 100%); color: #8B4500; }
        
        /* å½’æ¡£ & å¯¼èˆª */
        details summary { list-style: none; padding: 20px; background: #E5E5EA; border-radius: var(--radius-box); font-weight: 700; color: #666; display: flex; justify-content: space-between; align-items: center; }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .archived-list { background: #E5E5EA; border-bottom-left-radius: var(--radius-box); border-bottom-right-radius: var(--radius-box); padding: 0 20px 20px 20px; }
        .tab-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px;
            height: calc(var(--nav-height) + var(--safe-area-bottom)); background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; padding-bottom: var(--safe-area-bottom); z-index: 100;
        }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #999; font-size: 0.7rem; font-weight: 600; }
        .tab-item.active { color: black; }
        .tab-icon { width: 24px; height: 24px; background: currentColor; margin-bottom: 4px; border-radius: 6px; transition: transform 0.2s; }
        .tab-item.active .tab-icon { transform: scale(1.1); }

        /* è‡ªå®šä¹‰é€šç”¨å¼¹çª— */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .dialog-card {
            background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 30px 20px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .dialog-icon { font-size: 4rem; margin-bottom: 10px; }
        .dialog-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 10px; }
        .dialog-desc { font-size: 0.9rem; color: #666; line-height: 1.5; margin-bottom: 20px; }
        .dialog-status-tag { padding: 4px 12px; border-radius: 100px; font-size: 0.8rem; font-weight: 700; margin-bottom: 15px; }
        .dialog-input { width: 100%; padding: 15px; background: #F2F2F7; border: none; border-radius: 12px; font-size: 1rem; margin-bottom: 20px; outline: none; }
        .dialog-textarea { width: 100%; height: 80px; padding: 10px; background: #F2F2F7; border: none; border-radius: 12px; font-size: 0.8rem; margin-bottom: 20px; resize: none; outline: none; font-family: monospace; }
        
        .dialog-btn-group { display: flex; gap: 10px; width: 100%; }
        .dialog-btn-vertical { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        
        .dialog-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: none; font-size: 1rem; cursor: pointer; display:flex; justify-content: center; align-items: center; gap: 8px;}
        .btn-cancel { background: #F2F2F7; color: black; }
        .btn-confirm { background: var(--c-blue); color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        .btn-action { background: black; color: white; width: 100%; }
        .btn-action-outline { background: white; color: black; border: 2px solid #eee; width: 100%; }

        .small-tip { font-size: 0.7rem; color: #999; margin-top: 10px; }
        .dialog-divider { width: 100%; text-align: center; border-bottom: 1px solid #eee; line-height: 0.1em; margin: 20px 0; color: #999; font-size: 0.8rem; }
        .dialog-divider span { background: #fff; padding: 0 10px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 600; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 3000;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<input type="file" id="import-file" accept=".txt,.json" style="display:none" onchange="handleFileSelect(this)">

<div class="app-container">
    
    <div id="page-tracker" class="page active">
        <h1>ä¹ æƒ¯åˆ—è¡¨</h1>
        <div id="habit-list" class="card-list"></div>
        <div id="empty-state" style="display:none; text-align:center; padding:40px; color:#999;">
            è¿˜æ²¡æœ‰ä¹ æƒ¯ï¼Œå»"ç®¡ç†"é¡µé¢æ·»åŠ ä¸€ä¸ªå§ï¼
        </div>
    </div>

    <div id="page-manage" class="page">
        <h1>ä¹ æƒ¯ç®¡ç†</h1>
        <div class="card bg-blue" onclick="showDialog('new_habit')" style="margin-bottom: 24px; align-items: center; padding: 30px; cursor: pointer;">
            <div style="font-size: 3rem; line-height: 1;">+</div>
            <div style="font-weight: 700; margin-top: 10px;">åˆ›å»ºæ–°ä¹ æƒ¯</div>
        </div>
        
        <h2>è¿›è¡Œä¸­</h2>
        <div id="manage-active-list" class="card-list"></div>

        <h2 style="margin-top:40px; opacity:0.5;">å½’æ¡£ç®±</h2>
        <details>
            <summary>å·²å½’æ¡£çš„ä¹ æƒ¯ <span id="archive-count">0</span></summary>
            <div id="manage-archive-list" class="archived-list"></div>
        </details>

        <div class="card" style="margin-top:40px; background:#eee;" onclick="showDialog('export')">
            <div style="font-weight:700; text-align:center;">ğŸ“¤ å¤‡ä»½æ•°æ® (å¯¼å‡º)</div>
        </div>
        <div class="card" style="margin-top:10px; background:#eee;" onclick="showDialog('import')">
            <div style="font-weight:700; text-align:center;">ğŸ“¥ æ¢å¤æ•°æ® (å¯¼å…¥)</div>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h1>æˆ‘çš„æˆå°±</h1>
        
        <div class="card-list">
            <div class="card" style="flex-direction: row; align-items: center; gap: 20px; padding: 20px;">
                <div style="width: 60px; height: 60px; background: #000; border-radius: 50%; display:flex; justify-content:center; align-items:center; color:white; font-size:1.5rem;">â˜»</div>
                <div>
                    <div style="font-weight: 900; font-size: 1.5rem;">Habit User</div>
                    <div style="font-size: 0.9rem; color: #999;" id="total-stats">ç»Ÿè®¡åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="card">
                <div class="badge-header">
                    <h3>é‡Œç¨‹ç¢‘ Milestones</h3>
                    <div class="badge-toggle-btn" onclick="toggleGrid('milestone-grid', this)">æŸ¥çœ‹å…¨éƒ¨</div>
                </div>
                <div class="badge-grid collapsed" id="milestone-grid"></div>
            </div>

            <div class="card">
                <div class="badge-header">
                    <h3>ç‰¹æ®Šæˆå°± Achievements</h3>
                    <div class="badge-toggle-btn" onclick="toggleGrid('achievement-grid', this)">æŸ¥çœ‹å…¨éƒ¨</div>
                </div>
                <div class="badge-grid collapsed" id="achievement-grid"></div>
            </div>
            
             <div class="card" onclick="showDialog('reset')" style="background:#eee; color:#FF3B30; align-items:center; padding:15px;">
                <div style="font-weight:700;">âš  æ¸…ç©ºæ‰€æœ‰æ•°æ®</div>
            </div>
            
             <div class="card" onclick="showDialog('contact')" style="background:#eee; color:#333; align-items:center; padding:15px; margin-top: -10px;">
                <div style="font-weight:700;">ğŸ’¬ å­¦ä¹ äº¤æµåŒº</div>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('tracker', this)"><div class="tab-icon" style="background: var(--c-lemon);"></div><span>åˆ—è¡¨</span></div>
        <div class="tab-item" onclick="switchTab('manage', this)"><div class="tab-icon" style="background: var(--c-taro);"></div><span>ç®¡ç†</span></div>
        <div class="tab-item" onclick="switchTab('profile', this)"><div class="tab-icon" style="background: var(--c-blue);"></div><span>æˆ‘çš„</span></div>
    </nav>

    <div id="habit-modal" class="modal">
        <div class="modal-header">
            <h2 id="modal-title" style="margin:0; font-size:2rem;"></h2>
            <div class="close-btn" onclick="closeModal()">âœ•</div>
        </div>
        <div class="modal-content">
            <div class="view-toggle">
                <div class="view-btn active" onclick="switchView('grid')" id="btn-view-grid">è¿‘æœŸè§†å›¾</div>
                <div class="view-btn" onclick="switchView('year')" id="btn-view-year">å¹´åº¦è§†å›¾</div>
            </div>

            <div id="view-grid-container">
                <div class="card full" id="modal-heatmap-card" style="min-height:200px; justify-content:center; margin-bottom:15px; align-items:center;">
                    <div class="recent-grid" id="modal-recent-grid"></div>
                    <div class="label" style="text-align:center; margin-top:15px;">è¿‘14å¤©çŠ¶æ€</div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="card bg-taro"><div class="label">å½“å‰è¿èƒœ</div><div class="big-num" id="modal-streak">0</div></div>
                    <div class="card" style="background:#eee;"><div class="label">å†å²ç´¯è®¡</div><div class="big-num" id="modal-total" style="color:#999;">0</div></div>
                </div>
            </div>

            <div id="view-year-container" style="display:none;">
                <div class="year-tabs-container" id="year-tabs"></div>
                <div class="card full" style="overflow:hidden; margin-bottom:20px;">
                    <div class="year-grid-container"><div class="year-grid" id="year-heatmap"></div></div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card"><div class="label">å¹´åº¦å®Œæˆç‡</div><div class="stat-val" id="stat-year-rate">0%</div></div>
                    <div class="stat-card"><div class="label">æœ€é•¿è¿èƒœ</div><div class="stat-val" id="stat-year-streak">0</div></div>
                    <div class="stat-card"><div class="label">æœˆå‡æ‰“å¡</div><div class="stat-val" id="stat-year-avg">0</div></div>
                    <div class="stat-card"><div class="label">è¯¥å¹´æ€»è®¡</div><div class="stat-val" id="stat-year-total">0</div></div>
                </div>

                <div class="card full" style="margin-top:20px; background:#333; color:white;">
                    <div class="label" style="opacity:0.6;">ç”Ÿæ¶¯æ±‡æ€»</div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                        <div><div style="font-size:2rem; font-weight:900;" id="stat-life-days">0</div><div style="font-size:0.8rem; opacity:0.6;">è‡ª <span id="stat-life-start">--</span></div></div>
                        <div style="text-align:right;"><div style="font-size:2rem; font-weight:900;" id="stat-life-total">0</div><div style="font-size:0.8rem; opacity:0.6;">æ€»æ‰“å¡æ¬¡æ•°</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="check-btn-container" id="check-btn-container">
            <button id="btn-checkin" class="big-check-btn" onclick="handleModalCheckIn()"><span>âšª</span> é•¿æŒ‰æ‰“å¡</button>
        </div>
    </div>

    <div id="custom-dialog" class="dialog-overlay" onclick="closeDialog(event)">
        <div class="dialog-card" onclick="event.stopPropagation()">
            <div id="dialog-content"></div>
        </div>
    </div>
    
    <div id="toast" class="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

</div>

<script>
    // --- æ ¸å¿ƒæ•°æ® ---
    let habits = [];
    let currentHabitId = null;
    let pendingDeleteId = null;
    let selectedYearMode = 'rolling';
    
    const todayStr = new Date().toISOString().split('T')[0];
    const colors = ['bg-lemon', 'bg-taro', 'bg-blue', 'bg-green', 'bg-pink', 'bg-orange'];
    const MILESTONES = [3, 7, 21, 30, 60, 100, 180, 365, 500, 800, 1000, 3000];
    const ACHIEVEMENTS = [
        { id: 'first_blood', icon: 'ğŸ£', name: 'åˆå‡ºèŒ…åº', permanent: true },
        { id: 'early_bird', icon: 'ğŸŒ…', name: 'æ—©èµ·é¸Ÿ', permanent: false },
        { id: 'night_owl', icon: 'ğŸ¦‰', name: 'å¤œçŒ«å­', permanent: false },
        { id: 'double_kill', icon: 'âœŒï¸', name: 'åŒå“ç‚®', permanent: false },
        { id: 'triple_kill', icon: 'âš¡ï¸', name: 'ä¸‰è¿å‡»', permanent: false },
        { id: 'perfect_week', icon: 'ğŸ”¥', name: 'å®Œç¾å‘¨', permanent: false },
        { id: 'perfect_month', icon: 'ğŸ—“ï¸', name: 'å®Œç¾æœˆ', permanent: false },
        { id: 'weekend_warrior', icon: 'ğŸ›¡ï¸', name: 'å‘¨æœ«æˆ˜å£«', permanent: false },
        { id: 'phoenix', icon: 'ğŸ¦…', name: 'æµ´ç«é‡ç”Ÿ', permanent: false },
        { id: 'minimalist', icon: 'ğŸ“¦', name: 'æç®€ä¸»ä¹‰', permanent: true },
        { id: 'habit_master', icon: 'ğŸ‘‘', name: 'ä¹ æƒ¯å¤§å¸ˆ', permanent: false },
        { id: 'cleaner', icon: 'ğŸ§¹', name: 'æ–­èˆç¦»', permanent: true }
    ];
    let permAchieve = { first_blood: false, minimalist: false, cleaner: false };

    // --- æ•°æ® ---
    function loadData() {
        const saved = localStorage.getItem('habit_v6_data');
        const savedPerm = localStorage.getItem('habit_v6_perm');
        if (saved) habits = JSON.parse(saved);
        if (savedPerm) permAchieve = JSON.parse(savedPerm);
        if(!saved && !savedPerm) habits = [{ id: 1, name: "æ—©èµ·", created: todayStr, archived: false, history: {} }];
        renderAll();
    }
    function saveData() {
        localStorage.setItem('habit_v6_data', JSON.stringify(habits));
        localStorage.setItem('habit_v6_perm', JSON.stringify(permAchieve));
        renderAll();
    }
    function renderAll() { renderTrackerList(); renderManage(); renderProfile(); }

    // --- åˆ—è¡¨ ---
    function renderTrackerList() {
        const list = document.getElementById('habit-list');
        const empty = document.getElementById('empty-state');
        list.innerHTML = '';
        const active = habits.filter(h => !h.archived);
        if(active.length === 0) { empty.style.display='block'; return; } else { empty.style.display='none'; }
        active.forEach((h, idx) => {
            const color = colors[idx % colors.length];
            const stats = calculateStats(h);
            const isDone = !!h.history[todayStr];
            list.innerHTML += `
            <div class="card full ${color}" onclick="openModal(${h.id})" style="cursor:pointer;">
                <div class="list-card-header"><span class="habit-name">${h.name}</span><span style="background:rgba(0,0,0,0.1); padding:5px 10px; border-radius:20px; font-weight:700; font-size:0.8rem;">${isDone ? 'å·²å®Œæˆ' : 'å»æ‰“å¡'}</span></div>
                <div class="mini-stats"><div class="mini-stat-item"><span class="mini-stat-val">${stats.streak}</span><span class="mini-stat-lbl">STREAK</span></div><div class="mini-stat-item" style="opacity:0.6;"><span class="mini-stat-val">${stats.total}</span><span class="mini-stat-lbl">TOTAL</span></div></div>
            </div>`;
        });
    }

    // --- è¯¦æƒ… ---
    const modal = document.getElementById('habit-modal');
    function openModal(id) { currentHabitId=id; selectedYearMode = 'rolling'; switchView('grid'); updateModalContent(); modal.classList.add('open'); }
    function closeModal() { modal.classList.remove('open'); currentHabitId=null; }
    function switchView(mode) {
        document.getElementById('view-grid-container').style.display = mode==='grid'?'block':'none';
        document.getElementById('view-year-container').style.display = mode==='year'?'block':'none';
        document.getElementById('btn-view-grid').className = mode==='grid'?'view-btn active':'view-btn';
        document.getElementById('btn-view-year').className = mode==='year'?'view-btn active':'view-btn';
        document.getElementById('check-btn-container').style.display = mode==='grid'?'flex':'none';
        if(mode==='year') { renderYearTabs(); renderYearView(); }
    }
    function updateModalContent() {
        if(!currentHabitId) return;
        const h = habits.find(i=>i.id===currentHabitId);
        const stats = calculateStats(h);
        const isDone = !!h.history[todayStr];
        const color = colors[habits.indexOf(h) % colors.length];
        
        document.getElementById('modal-title').innerText = h.name;
        document.getElementById('modal-streak').innerText = stats.streak;
        document.getElementById('modal-total').innerText = stats.total;
        document.getElementById('modal-heatmap-card').className = `card full ${color}`;

        const grid = document.getElementById('modal-recent-grid'); grid.innerHTML='';
        for(let i=13; i>=0; i--){
            const d=new Date(); d.setDate(d.getDate()-i); const k=d.toISOString().split('T')[0];
            const active = !!h.history[k]; const isToday = (k === todayStr);
            grid.innerHTML += `<div class="recent-block ${active?'active':''} ${isToday&&!active?'today':''}" style="background:${active?'rgba(0,0,0,0.2)':'rgba(0,0,0,0.05)'}; color:${active?'rgba(0,0,0,0.5)':'rgba(0,0,0,0.2)'}">${d.getDate()}</div>`;
        }

        const btn = document.getElementById('btn-checkin');
        if(isDone) { btn.classList.add('checked'); btn.innerHTML='<span>âœ“</span> ä»Šæ—¥å·²å®Œæˆ'; }
        else { btn.classList.remove('checked'); btn.innerHTML='<span>âšª</span> é•¿æŒ‰æ‰“å¡'; }
        if(document.getElementById('view-year-container').style.display==='block') { renderYearView(); }
    }

    // --- å¹´åº¦ ---
    function renderYearTabs() {
        const h = habits.find(i=>i.id===currentHabitId);
        const tabs = document.getElementById('year-tabs'); tabs.innerHTML = '';
        tabs.innerHTML += `<div class="year-tab ${selectedYearMode==='rolling'?'active':''}" onclick="switchYearMode('rolling')">è¿‘ä¸€å¹´</div>`;
        const createYear = new Date(h.created).getFullYear(); const currentYear = new Date().getFullYear();
        for(let y=currentYear; y>=createYear; y--) { tabs.innerHTML += `<div class="year-tab ${selectedYearMode===y?'active':''}" onclick="switchYearMode(${y})">${y}</div>`; }
    }
    function switchYearMode(mode) { selectedYearMode = mode; renderYearTabs(); renderYearView(); }
    function renderYearView() {
        if(!currentHabitId) return;
        const h = habits.find(i=>i.id===currentHabitId);
        const container = document.getElementById('year-heatmap'); container.innerHTML='';
        const colorClass = colors[habits.indexOf(h) % colors.length];
        const hexMap = {'bg-lemon':'#EBFF00','bg-taro':'#C8B6FF','bg-blue':'#4A90E2','bg-green':'#34C759','bg-pink':'#FF2D55','bg-orange':'#FF9500'};
        const activeColor = hexMap[colorClass] || '#000';

        let startDate, endDate;
        if(selectedYearMode === 'rolling') { endDate = new Date(); startDate = new Date(); startDate.setDate(endDate.getDate() - 364); if(startDate < new Date(h.created)) startDate = new Date(h.created); } 
        else { startDate = new Date(selectedYearMode, 0, 1); endDate = new Date(selectedYearMode, 11, 31); const now = new Date(); if(endDate > now) endDate = now; if(startDate < new Date(h.created)) startDate = new Date(h.created); }

        let loopDate = new Date(startDate); let lastMonth = -1; let totalRangeDays = 0; let activeCount = 0; let maxStreak = 0; let currentStreak = 0;
        
        while(loopDate <= endDate) {
            const k = loopDate.toISOString().split('T')[0]; const isActive = !!h.history[k]; const currentMonth = loopDate.getMonth();
            if(lastMonth !== -1 && currentMonth !== lastMonth) { container.innerHTML += `<div class="month-separator"></div>`; }
            container.innerHTML += `<div class="year-dot" style="background:${isActive ? activeColor : '#eee'}"></div>`;
            totalRangeDays++; if(isActive) { activeCount++; currentStreak++; if(currentStreak > maxStreak) maxStreak = currentStreak; } else { currentStreak = 0; }
            lastMonth = currentMonth; loopDate.setDate(loopDate.getDate() + 1);
        }
        setTimeout(()=>{document.querySelector('.year-grid-container').scrollLeft = 10000;}, 50);

        const monthsPassed = Math.max(1, totalRangeDays / 30);
        document.getElementById('stat-year-rate').innerText = (totalRangeDays>0 ? Math.round((activeCount/totalRangeDays)*100) : 0) + '%';
        document.getElementById('stat-year-streak').innerText = maxStreak;
        document.getElementById('stat-year-avg').innerText = (activeCount / monthsPassed).toFixed(1);
        document.getElementById('stat-year-total').innerText = activeCount;

        const lifeStart = new Date(h.created);
        document.getElementById('stat-life-days').innerText = (Math.floor((new Date() - lifeStart)/(1000*60*60*24)) + 1) + ' å¤©';
        document.getElementById('stat-life-start').innerText = h.created;
        document.getElementById('stat-life-total').innerText = Object.keys(h.history).length;
    }

    function handleModalCheckIn() {
        if(!currentHabitId) return;
        const h = habits.find(i=>i.id===currentHabitId);
        if(h.history[todayStr]) delete h.history[todayStr];
        else { h.history[todayStr] = new Date().toTimeString().slice(0,5); permAchieve.first_blood = true; }
        saveData(); updateModalContent();
    }

    // --- ä¸ªäºº ---
    function renderProfile() {
        let totalGlobal = 0; habits.forEach(h => totalGlobal += Object.keys(h.history).length);
        document.getElementById('total-stats').innerText = `ç´¯è®¡æ‰“å¡: ${totalGlobal}`;
        const mileGrid = document.getElementById('milestone-grid'); mileGrid.innerHTML = '';
        MILESTONES.forEach(num => {
            const unlocked = totalGlobal >= num;
            mileGrid.innerHTML += `<div class="badge ${unlocked?'unlocked gold':''}" onclick="showDialog('badge', {icon:'${num}', name:'é‡Œç¨‹ç¢‘ ${num}', desc:'å†å²ç´¯è®¡æ€»æ‰“å¡è¾¾åˆ° ${num} æ¬¡', unlocked:${unlocked}})"><div class="badge-icon" style="font-weight:900; font-size:1rem;">${num}</div><div class="badge-text">æ¬¡</div></div>`;
        });
        const achGrid = document.getElementById('achievement-grid'); achGrid.innerHTML = '';
        const status = calculateAchievementStatus();
        ACHIEVEMENTS.forEach(ach => {
            const unlocked = status[ach.id];
            achGrid.innerHTML += `<div class="badge ${unlocked?'unlocked':''}" onclick="showDialog('badge', {icon:'${ach.icon}', name:'${ach.name}', desc:'${getAchDesc(ach.id)}', unlocked:${unlocked}})"><div class="badge-icon">${ach.icon}</div><div class="badge-text">${ach.name}</div></div>`;
        });
    }

    // --- å¼¹çª—é€»è¾‘ (V6.1 å¢å¼ºç‰ˆ) ---
    const dialog = document.getElementById('custom-dialog');
    const dialogContent = document.getElementById('dialog-content');

    function closeDialog(e) { if(e) e.stopPropagation(); dialog.style.display = 'none'; pendingDeleteId = null; }

    function showDialog(type, data) {
        let html = '';
        if (type === 'badge') {
            html = `<div class="dialog-icon">${data.icon}</div><div class="dialog-title">${data.name}</div><div class="dialog-status-tag" style="background:${data.unlocked?'#E8FFE8':'#eee'}; color:${data.unlocked?'#34C759':'#999'}">${data.unlocked ? 'âœ… å·²è§£é”' : 'ğŸ”’ æœªè§£é”'}</div><div class="dialog-desc">${data.desc}</div><button class="dialog-btn btn-confirm" onclick="closeDialog()">æˆ‘çŸ¥é“äº†</button>`;
        } else if (type === 'new_habit') {
            html = `<div class="dialog-title">åˆ›å»ºæ–°ä¹ æƒ¯</div><input type="text" id="dialog-input-val" class="dialog-input" placeholder="ä¾‹å¦‚ï¼šæ—©èµ·æ™¨è·‘" autofocus><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-confirm" onclick="confirmNewHabit()">ç¡®å®š</button></div>`;
        } else if (type === 'delete_confirm') {
            pendingDeleteId = data;
            html = `<div class="dialog-title">åˆ é™¤ä¹ æƒ¯</div><div class="dialog-desc" style="color:#FF3B30;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</div><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-danger" onclick="executeDelete()">åˆ é™¤</button></div>`;
        } else if (type === 'reset') {
            html = `<div class="dialog-title">æ¸…ç©ºæ•°æ®</div><div class="dialog-desc" style="color:#FF3B30;">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ä¹ æƒ¯å’Œå†å²è®°å½•ï¼Œæ— æ³•æ’¤é”€ï¼</div><div class="dialog-btn-group"><button class="dialog-btn btn-cancel" onclick="closeDialog()">å–æ¶ˆ</button><button class="dialog-btn btn-danger" onclick="executeReset()">æ¸…ç©º</button></div>`;
        } else if (type === 'contact') {
            html = `<div class="dialog-title">åˆ¶ä½œè€…å¾®ä¿¡</div><div class="dialog-desc" style="font-size:1.5rem; font-weight:900; color:var(--c-blue); margin:20px 0; cursor:pointer;" onclick="copyContact('Glimmer-0000')">Glimmer-0000</div><div class="dialog-desc" style="font-size:0.8rem;">ä¸€èµ·äº¤æµä¹ æƒ¯å…»æˆã€Aiå¼€å‘ï¼Œç‚¹å‡»ä¸Šæ–¹å¾®ä¿¡å·å¯å¤åˆ¶</div><button class="dialog-btn btn-confirm" onclick="closeDialog()">å…³é—­</button>`;
        } 
        
        // V6.1 å¢å¼ºå¯¼å‡º
        else if (type === 'export') {
            const json = JSON.stringify({ h: habits, p: permAchieve });
            // å°†æ•°æ®æš‚å­˜åˆ°å†…å­˜ï¼Œä¾›æŒ‰é’®è°ƒç”¨
            window.tempExportData = json;
            html = `
                <div class="dialog-title">å¤‡ä»½æ•°æ®</div>
                <div class="dialog-desc">è¯·é€‰æ‹©ä¸€ç§æ–¹å¼ä¿å­˜æ‚¨çš„æ•°æ®ï¼š</div>
                <div class="dialog-btn-vertical">
                    <button class="dialog-btn btn-action" onclick="copyExportData()">ğŸ“‹ ä¸€é”®å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                    <button class="dialog-btn btn-action-outline" onclick="downloadBackupFile()">ğŸ’¾ å¯¼å‡ºä¸º .txt æ–‡ä»¶</button>
                </div>
                <div class="small-tip">æ¨èä¿å­˜ä¸ºæ–‡ä»¶ï¼Œæ•°æ®æ›´å®‰å…¨</div>
                <button class="dialog-btn btn-cancel" style="margin-top:15px" onclick="closeDialog()">å…³é—­</button>
            `;
        } 
        
        // V6.1 å¢å¼ºå¯¼å…¥
        else if (type === 'import') {
            html = `
                <div class="dialog-title">æ¢å¤æ•°æ®</div>
                <div class="dialog-desc" style="color:red;">âš ï¸ æ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼</div>
                
                <button class="dialog-btn btn-action" onclick="triggerFileSelect()">ğŸ“‚ é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¯¼å…¥...</button>
                
                <div class="dialog-divider"><span>æˆ–</span></div>
                
                <textarea id="dialog-text-val" class="dialog-textarea" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬ä»£ç ..."></textarea>
                <div class="dialog-btn-group">
                    <button class="dialog-btn btn-cancel" onclick="closeDialog()">å–æ¶ˆ</button>
                    <button class="dialog-btn btn-confirm" onclick="confirmTextImport()">ç¡®è®¤æ–‡æœ¬æ¢å¤</button>
                </div>
                <div class="small-tip" style="margin-top:10px">ä¸€é”®ç²˜è´´åˆ°æ–°æµè§ˆå™¨å¯¼å…¥æˆ–è€…é€šè¿‡txtå¯¼å‡ºå¯¼å…¥</div>
            `;
        }

        dialogContent.innerHTML = html; dialog.style.display = 'flex';
        const input = document.getElementById('dialog-input-val'); if(input) setTimeout(() => input.focus(), 100);
    }

    // --- å¯¼å‡º/å¯¼å…¥ åŠŸèƒ½å®ç° ---
    
    // 1. å¤åˆ¶æ–‡æœ¬
    function copyExportData() {
        copyContact(window.tempExportData); // å¤ç”¨å¤åˆ¶å‡½æ•°
        closeDialog();
    }

    // 2. ä¸‹è½½æ–‡ä»¶
    function downloadBackupFile() {
        const data = window.tempExportData;
        const blob = new Blob([data], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const date = new Date().toISOString().split('T')[0];
        a.download = `Habit_Backup_${date}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        closeDialog();
    }

    // 3. è§¦å‘æ–‡ä»¶é€‰æ‹©
    function triggerFileSelect() {
        document.getElementById('import-file').click();
    }

    // 4. å¤„ç†æ–‡ä»¶è¯»å–
    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            processImport(content);
        };
        reader.readAsText(file);
        // æ¸…ç©º input é˜²æ­¢é‡å¤é€‰æ‹©åŒæ–‡ä»¶ä¸è§¦å‘ change
        input.value = ''; 
    }

    // 5. ç¡®è®¤æ–‡æœ¬å¯¼å…¥
    function confirmTextImport() {
        const val = document.getElementById('dialog-text-val').value;
        if(val) processImport(val);
    }

    // æ ¸å¿ƒå¯¼å…¥é€»è¾‘
    function processImport(jsonString) {
        try {
            const json = JSON.parse(jsonString);
            if(json.h) { 
                habits = json.h; 
                permAchieve = json.p || permAchieve; 
                saveData(); 
                alert("æ¢å¤æˆåŠŸï¼"); 
                location.reload(); 
            } else {
                alert("æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
            }
        } catch(e) { 
            alert("ä»£ç æ ¼å¼é”™è¯¯æˆ–æ–‡ä»¶æŸå"); 
        }
    }

    // --- å…¶ä»–åŠŸèƒ½ ---
    function confirmNewHabit() { const val = document.getElementById('dialog-input-val').value; if(val) { habits.push({id:Date.now(), name:val, created:todayStr, archived:false, history:{}}); saveData(); closeDialog(); } }
    function triggerDelete(id) { showDialog('delete_confirm', id); }
    function executeDelete() { if(pendingDeleteId) { habits = habits.filter(h => h.id !== pendingDeleteId); permAchieve.cleaner = true; saveData(); closeDialog(); } }
    function executeReset() { localStorage.clear(); location.reload(); }
    function copyContact(text) { navigator.clipboard.writeText(text).then(() => { const toast = document.getElementById('toast'); toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 2000); }).catch(err => { alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶"); }); }
    function renderManage() {
        const active = document.getElementById('manage-active-list'); const archive = document.getElementById('manage-archive-list'); active.innerHTML=''; archive.innerHTML=''; let arcCount = 0;
        habits.forEach(h => {
            const html = `<div class="card" style="padding:20px; margin-bottom:10px; flex-direction:row; justify-content:space-between; align-items:center;"><div style="font-weight:800; ${h.archived?'opacity:0.5':''}">${h.name}</div><div style="display:flex; gap:10px;"><div style="background:#eee; padding:8px 15px; border-radius:20px; font-size:0.8rem; font-weight:700;" onclick="toggleArchive(${h.id})">${h.archived?'æ¢å¤':'å½’æ¡£'}</div>${h.archived?`<div style="background:#ffebeb; color:red; padding:8px 15px; border-radius:20px; font-size:0.8rem;" onclick="triggerDelete(${h.id})">åˆ é™¤</div>`:''}</div></div>`;
            if(h.archived) { archive.innerHTML+=html; arcCount++; } else active.innerHTML+=html;
        }); document.getElementById('archive-count').innerText = arcCount;
    }
    function toggleArchive(id) { const h=habits.find(i=>i.id===id); if(h){h.archived=!h.archived; if(h.archived) permAchieve.minimalist=true; saveData();} }
    function switchTab(p,el){document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));document.getElementById('page-'+p).classList.add('active');document.querySelectorAll('.tab-item').forEach(x=>x.classList.remove('active'));el.classList.add('active');}
    function resetAllData(){ showDialog('reset'); }
    function calculateStats(h) { let s=0;let d=new Date();if(!h.history[todayStr])d.setDate(d.getDate()-1);while(h.history[d.toISOString().split('T')[0]]){s++;d.setDate(d.getDate()-1);}return {streak:s, total:Object.keys(h.history).length}; }
    function calculateAchievementStatus() { return { first_blood: permAchieve.first_blood, early_bird: checkGlobalEarlyBird(), night_owl: checkGlobalNightOwl(), double_kill: checkDailyCount() >= 2, triple_kill: checkDailyCount() >= 3, perfect_week: checkGlobalPerfect(7), perfect_month: checkGlobalPerfect(30), weekend_warrior: checkWeekendWarrior(), phoenix: checkGlobalPhoenix(), minimalist: permAchieve.minimalist, habit_master: habits.filter(h=>!h.archived).length >= 5, cleaner: permAchieve.cleaner }; }
    function checkGlobalEarlyBird() { for(let i=0; i<5; i++) { const d=new Date();d.setDate(d.getDate()-i);const k=d.toISOString().split('T')[0];let has=false;for(let h of habits){if(h.history[k]&&h.history[k]<"08:00"){has=true;break;}}if(!has)return false;}return true; }
    function checkGlobalNightOwl() { for(let i=0; i<3; i++) { const d=new Date();d.setDate(d.getDate()-i);const k=d.toISOString().split('T')[0];let has=false;for(let h of habits){if(h.history[k]&&h.history[k]>="23:00"){has=true;break;}}if(!has)return false;}return true; }
    function checkDailyCount() { let c=0; habits.forEach(h=>{if(h.history[todayStr])c++}); return c; }
    function checkGlobalPerfect(d){ for(let i=0;i<d;i++){const dt=new Date();dt.setDate(dt.getDate()-i);const k=dt.toISOString().split('T')[0];if(!habits.some(h=>!!h.history[k]))return false;}return true;}
    function checkWeekendWarrior(){let w=0;let d=new Date();while(w<8){const day=d.getDay();if(day===0||day===6){const k=d.toISOString().split('T')[0];if(!habits.some(h=>!!h.history[k]))return false;w++;}d.setDate(d.getDate()-1);if((new Date()-d)>3456000000)break;}return true;}
    function checkGlobalPhoenix(){return habits.some(h=>{const s=calculateStats(h);if(s.streak<3)return false;const d=new Date();d.setDate(d.getDate()-s.streak);const k=d.toISOString().split('T')[0];return !h.history[k];});}
    function toggleGrid(id, btn) { const grid = document.getElementById(id); if(grid.classList.contains('collapsed')) { grid.classList.remove('collapsed'); btn.innerText = 'æ”¶èµ·'; } else { grid.classList.add('collapsed'); btn.innerText = 'æŸ¥çœ‹å…¨éƒ¨'; } }
    function getAchDesc(id) { const map = { first_blood: 'å®Œæˆç¬¬1æ¬¡æ‰“å¡', early_bird: 'è¿ç»­5å¤©åœ¨08:00å‰æ‰“å¡', night_owl: 'è¿ç»­3å¤©åœ¨23:00åæ‰“å¡', double_kill: 'å•æ—¥å®Œæˆ2ä¸ªä¹ æƒ¯', triple_kill: 'å•æ—¥å®Œæˆ3ä¸ªä¹ æƒ¯', perfect_week: 'è¿‡å»7å¤©æ¯å¤©éƒ½æœ‰æ‰“å¡', perfect_month: 'è¿‡å»30å¤©æ¯å¤©éƒ½æœ‰æ‰“å¡', weekend_warrior: 'è¿ç»­4ä¸ªå‘¨æœ«æ— ç¼ºå¸­', phoenix: 'æ–­ç­¾åé‡æ–°è¿ç»­æ‰“å¡3å¤©', minimalist: 'ä½¿ç”¨è¿‡å½’æ¡£åŠŸèƒ½', habit_master: 'æ‹¥æœ‰5ä¸ªåŠä»¥ä¸Šè¿›è¡Œä¸­çš„ä¹ æƒ¯', cleaner: 'åˆ é™¤è¿‡ä¸€ä¸ªä¹ æƒ¯' }; return map[id] || ''; }

    loadData();
</script>
</body>
</html>
